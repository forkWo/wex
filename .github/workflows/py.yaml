name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '*/60 * * * *'

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json"

jobs:
  modify:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get install -y jq
          pip install requests

      - name: ä¸‹è½½ JSON æ•°æ®
        run: |
          python3 <<EOF
          import requests

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
              "Accept": "application/json, text/plain, */*",
              "Accept-Language": "en-US,en;q=0.9",
              "Accept-Encoding": "gzip, deflate, br",
              "Connection": "keep-alive",
              "Referer": "https://example.com/",
              "Sec-Fetch-Dest": "empty",
              "Sec-Fetch-Mode": "cors",
              "Sec-Fetch-Site": "same-origin"
          }

          response = requests.get("${{ env.JSON_URL }}", headers=headers, stream=True)
          response.raise_for_status()

          with open("9280.json", "wb") as f:
              for chunk in response.iter_content(chunk_size=8192):
                  f.write(chunk)
          EOF
          
      - name: æå–å¹¶å¤„ç† Spider å†…å®¹
        id: spider
        run: |
          SPIDER_CONTENT=$(jq -r '.spider // "" | gsub("\n"; "\\n")' 9280.json)
          echo "SPIDER_CONTENT=$SPIDER_CONTENT" >> $GITHUB_ENV

      - name: è·å–å†å² Spider
        id: history
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          RESP=$(curl -sf -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")

          PREVIOUS_SPIDER=$(jq -r '
            if .message == "Not Found" then
              "no_history"
            else
              (.body | split("Spider Content: ")[1] // "")
            end
          ' <<< "$RESP")

          echo "PREVIOUS_SPIDER=$PREVIOUS_SPIDER" >> $GITHUB_ENV

      - name: å¯¹æ¯”å†…å®¹
        id: comparator
        run: |
          if [[ "$SPIDER_CONTENT" != "$PREVIOUS_SPIDER" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: å¤„ç† JSON
        if: steps.comparator.outputs.changed == 'true'
        run: |
          python3 <<EOF
          import json

          # é…ç½®æ˜ å°„
          NAME_MAPPING = {
              "Douban": "ğŸ®ã€æ¨èã€‘ğŸ®",
              "Wexokconfig": "ğŸ®é…ç½®ä¸­å¿ƒğŸ®",
              "Wexnullname": "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"
          }
          PRIORITY_MAP = {"Douban": 1, "Wexokconfig": 2, "ç©å¶": 3}
          KEYS_TO_DELETE = [
              "Doubana", #â¬‡ï¸ã€ç½‘ç›˜ç±»å…ˆæ‰«ç ã€‘â¬‡ï¸
              "Wexconfig", #ğŸ®é€šç”¨ç±»å‹â”ƒé…ç½®ä¸­å¿ƒğŸ®
              "Wexalllive", #ğŸ’“â€èšåˆâ”ƒç›´æ’­ğŸ’“
              "mingriyingshi", #ğŸ˜æ˜æ—¥â”ƒå½±è§†ğŸ˜
              "Fujutv", #ğŸ˜è…å‰§â”ƒå½±è§†ğŸ˜
              "Wexsaohuo", #ğŸ‡ç«ç«â”ƒç§’æ’­ğŸ‡
              "csp_Nmys", #ğŸ‡ä¼¯ä¼¯â”ƒç§’æ’­ğŸ‡
              "éå‡¡","æœ¨è€³", 
              "360", "çˆ±å¤", 
              "æ–°6V","è³¤è³¤",
              "Wexhanxiaoquan", #ğŸŒºéŸ©åœˆâ”ƒç§’æ’­ğŸŒº
              "Wexduanjuquark", #ğŸ‰çŸ­å‰§â”ƒå¤¸å…‹ğŸ‰
              "Wexduanjuvop", #ğŸ‰çŸ­å‰§â”ƒç§’æ’­ğŸ‰
              "Wexduanjuhema", #ğŸ‰çŸ­å‰§â”ƒä»™å“ğŸ‰
              "WexduanjuvmpGuard", #ğŸ‰çŸ­å‰§â”ƒå¸å“ğŸ‰
              "WexduanjuvipGuard", #ğŸ‰çŸ­å‰§â”ƒç¥å“ğŸ‰
              "Wexduanju001", #ğŸ‰çŸ­å‰§â”ƒæå“ğŸ‰
              "Wexliyuan", #ğŸæˆæ›²â”ƒç§’æ’­ğŸ
              "Wextangdou", #ğŸ’ƒè·³èˆâ”ƒæ•™å­¦ğŸ’ƒ
              "Wexergeduoduo", #ğŸ‘¼å¤šå¤šâ”ƒå„¿æ­ŒğŸ‘¼
              "Wexbaobaobashi", #ğŸ‘¼å®å®â”ƒå„¿æ­ŒğŸ‘¼
              "Wexbeiwa", #ğŸ‘¼è´è´â”ƒå„¿æ­ŒğŸ‘¼
              "Wextuxiaobei", #ğŸ‘¼å…”å…”â”ƒå„¿æ­ŒğŸ‘¼
              "Pandalivetv", #ğŸ˜éŸ©å›½â”ƒç›´æ’­ğŸ˜
              "Iktv", "è‡ªå®šä¹‰", 
              "AList","bili",
              "biliych", #ğŸ…±å“”å“”â”ƒæ­Œæ›²ğŸ…±
              "Wexqingfengdj", #ğŸ¼èˆæ›²â”ƒæ‘‡å¤´ğŸ¼
              "Wexxsmp3", #ğŸ¤éšèº«â”ƒç›¸å£°ğŸ¤
              "Wexpsmp3", #ğŸ¤éšèº«â”ƒè¯„ä¹¦ğŸ¤
              "Wexwwe", #ğŸŒæ ¼æ–—â”ƒWWEğŸŒ
              "çœ‹çƒ", 
              "926çœ‹çƒ", 
              "1ç›´æ’­",
          ]

          # è¯»å–åŸå§‹ JSON
          with open("9280.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          # åˆ é™¤é¡¶å±‚é”®
          data.pop("doh", None)
          data.pop("lives", None)

          # å¤„ç†ç«™ç‚¹æ•°æ®
          sites = []
          for site in data.get("sites", []):
              key = site.get("key")
              
              if key in KEYS_TO_DELETE:
                  continue
              
              # æ›´æ–°ç«™ç‚¹åç§°
              if key in NAME_MAPPING:
                  site["name"] = NAME_MAPPING[key]
              
              sites.append(site)

          # æ’åºé€»è¾‘
          sites.sort(key=lambda x: PRIORITY_MAP.get(x.get("key"), 4))
          data["sites"] = sites

          # ä¿å­˜ç»“æœ
          with open("${{ env.FINAL_JSON }}", "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          EOF

      - name: ä¸Šä¼ æ–‡ä»¶
        if: steps.comparator.outputs.changed == 'true'
        run: |
          curl -sSf -o /dev/null \
            https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} \
            -F "file=@${{ env.FINAL_JSON }}"

      - name: å‘å¸ƒç‰ˆæœ¬
        if: steps.comparator.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          gh release create v$(date +%s) \
            --title "$(date +%F)" \
            --notes "Spider Content: $SPIDER_CONTENT" \
            --target ${{ github.sha }}

      - name: æ¸…ç†å†å²
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          RUNS=$(curl -sf -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")
          
          jq -r '.workflow_runs | sort_by(.run_number) | reverse | .[1:][] | .id' <<< "$RUNS" | \
            xargs -I{} curl -sf -X DELETE -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/{}"