name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *' # 每 10 分钟触发一次

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # 最终文件命名为 wex.json

jobs:
  modify:
    runs-on: ubuntu-latest

    steps:
      # 第一步：设置 Python 环境
      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 第二步：安装 jq 工具
      - name: 安装 jq
        run: sudo apt-get install -y jq

      # 第三步：下载 JSON 文件
      - name: 下载 JSON 数据
        id: download_json
        run: |
          curl -s "${{ env.JSON_URL }}" -o 9280.json
          echo "JSON 文件下载完成。"

      # 第四步：获取完整的 spider 字段
      - name: 获取完整的 spider 字段
        id: get_spider_content
        run: |
          SPIDER_CONTENT=$(jq -r '.spider' 9280.json)
          echo "当前 Spider 字段内容: $SPIDER_CONTENT"
          echo "SPIDER_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$SPIDER_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 第五步：获取上一个 Releases 版本的 spider 字段
      - name: 获取上一个 Releases 版本的 spider 字段
        id: get_previous_spider_content
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}  # 使用 PAT
        run: |
          LATEST_RELEASE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          echo "GitHub API 响应: $LATEST_RELEASE"  # 调试输出

          # 检查是否有 Releases
          if [[ $(echo "$LATEST_RELEASE" | jq -r '.message') == "Not Found" ]]; then
            echo "仓库中没有 Releases，跳过对比。"
            echo "PREVIOUS_SPIDER_CONTENT=no_releases" >> $GITHUB_ENV
          else
            # 提取 body 内容
            BODY=$(echo "$LATEST_RELEASE" | jq -r '.body')
            echo "body 内容: $BODY"  # 调试输出

            # 提取完整的 spider 字段内容
            PREVIOUS_SPIDER_CONTENT=$(echo "$BODY" | grep -oP 'Spider Content: \K.*')
            echo "提取的 Spider 字段内容: $PREVIOUS_SPIDER_CONTENT"  # 调试输出

            # 将内容写入环境变量
            echo "PREVIOUS_SPIDER_CONTENT=$PREVIOUS_SPIDER_CONTENT" >> $GITHUB_ENV
          fi

      # 第六步：对比 spider 字段
      - name: 对比 spider 字段
        id: compare_spider
        run: |
          if [[ "$SPIDER_CONTENT" != "$PREVIOUS_SPIDER_CONTENT" ]]; then
            echo "Spider 字段已修改，需要处理 JSON 文件。"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "Spider 字段未修改，无需处理 JSON 文件。"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # 第七步：修改 JSON 文件（仅在 changed 为 true 时执行）
      - name: 修改 JSON 文件
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          python3 <<EOF
          import json
          import hashlib

          # 输入和输出文件路径
          input_file = "9280.json"
          output_file = "${{ env.FINAL_JSON }}"

          # 需要删除的键列表
          keys_to_delete = [
              "Doubana", #⬇️【网盘类先扫码】⬇️
              "Wexconfig", #🐮通用类型┃配置中心🐮
              "Wexalllive", #💓‍聚合┃直播💓
              "mingriyingshi", #😁明日┃影视😁
              "Fujutv", #😁腐剧┃影视😁
              "Wexsaohuo", #🎇火火┃秒播🎇
              "csp_Nmys", #🎇伯伯┃秒播🎇
              "非凡","木耳", 
              "360", "爱坤", 
              "Wexhanxiaoquan", #🌺韩圈┃秒播🌺
              "Wexduanjuquark", #🍉短剧┃夸克🍉
              "Wexduanjuvop", #🍉短剧┃秒播🍉
              "Wexduanjuhema", #🍉短剧┃仙品🍉
              "WexduanjuvmpGuard", #🍉短剧┃帝品🍉
              "WexduanjuvipGuard", #🍉短剧┃神品🍉
              "Wexduanju001", #🍉短剧┃极品🍉
              "Wexliyuan", #🎎戏曲┃秒播🎎
              "Wextangdou", #💃跳舞┃教学💃
              "Wexergeduoduo", #👼多多┃儿歌👼
              "Wexbaobaobashi", #👼宝宝┃儿歌👼
              "Wexbeiwa", #👼贝贝┃儿歌👼
              "Wextuxiaobei", #👼兔兔┃儿歌👼
              "Pandalivetv", #😍韩国┃直播😍
              "Iktv", "自定义", 
              "AList","bili",
              "biliych", #🅱哔哔┃歌曲🅱
              "Wexqingfengdj", #🎼舞曲┃摇头🎼
              "Wexxsmp3", #🎤随身┃相声🎤
              "Wexpsmp3", #🎤随身┃评书🎤
              "Wexwwe", #🌐格斗┃WWE🌐
              "看球", 
              "926看球", 
              "1直播",
          ]

          # 读取原始 JSON 文件
          with open(input_file, "r", encoding="utf-8") as f:
              data = json.load(f)

          # 删除不需要的键
          if "doh" in data:
              del data["doh"]
          if "lives" in data:
              del data["lives"]

          # 修改特定键的名称
          for site in data.get("sites", []):
              if site.get("key") == "Douban":
                  site["name"] = "🐮【推荐】🐮"
              elif site.get("key") == "Wexokconfig":
                  site["name"] = "🐮配置中心🐮"
              elif site.get("key") == "Wexnullname":
                  site["name"] = "💓观影┃4K💓"

          # 过滤掉不需要的站点
          data["sites"] = [site for site in data.get("sites", []) if site.get("key") not in keys_to_delete]

          # 重新排序 sites 数组，将 "玩偶" 放在 "Wexokconfig" 后面
          def sort_sites(site):
              if site.get("key") == "Douban":
                  return 1
              elif site.get("key") == "Wexokconfig":
                  return 2
              elif site.get("key") == "玩偶":
                  return 3
              else:
                  return 4

          data["sites"].sort(key=sort_sites)

          # 保存修改后的 JSON 文件
          with open(output_file, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print("JSON 文件处理完成，保存为:", output_file)
          EOF

      # 第八步：上传文件到 Kstore（仅在 changed 为 true 时执行）
      - name: 上传文件到 Kstore
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          curl https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"

      # 第九步：发布新的 Releases（仅在 changed 为 true 时执行）
      - name: 发布新的 Releases
        if: steps.compare_spider.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}  # 使用 PAT
        run: |
          # 切换到 GitHub Actions 的默认工作目录
          cd $GITHUB_WORKSPACE

          # 检查当前目录是否是 Git 仓库
          if ! git rev-parse --git-dir > /dev/null 2>&1; then
            echo "当前目录不是 Git 仓库，正在初始化 Git 仓库..."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
          fi

          # 发布新的 Releases，包含完整的 spider 字段内容
          gh release create v$(date +%Y%m%d%H%M%S) --title "$(date +%Y-%m-%d)" --notes "Spider Content: $SPIDER_CONTENT"

      # 第十步：删除旧的工作流运行记录
      - name: 删除旧的工作流运行记录
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取工作流运行记录
          RUNS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")

          # 提取需要删除的运行记录 ID
          OLD_RUN_IDS=$(echo "$RUNS" | jq -r '.workflow_runs[] | select(.status == "completed") | .id')

          # 删除旧的工作流运行记录
          for RUN_ID in $OLD_RUN_IDS; do
            echo "正在删除工作流运行记录: $RUN_ID"
            curl -s -X DELETE -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID"
          done