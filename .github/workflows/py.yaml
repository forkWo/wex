name: Wex JSON Upload (Python)

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # æ¯ä¸¤ä¸ªå°æ—¶è§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # æœ€ç»ˆæ–‡ä»¶å‘½åä¸º wex.json

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # ç¬¬äºŒæ­¥ï¼šä¸‹è½½ JSON æ–‡ä»¶
      - name: ä¸‹è½½ JSON æ•°æ®
        id: download_json
        run: |
          curl -s "${{ env.JSON_URL }}" -o 9280.json
          ORIGINAL_CRC32=$(python3 -c "import zlib; print(zlib.crc32(open('9280.json', 'rb').read()) & 0xffffffff)")
          echo "åŸå§‹ JSON æ–‡ä»¶çš„ CRC32: $ORIGINAL_CRC32"
          echo "ORIGINAL_CRC32=$ORIGINAL_CRC32" >> $GITHUB_ENV

      # ç¬¬ä¸‰æ­¥ï¼šæå– spider å­—æ®µå¹¶è®¡ç®— MD5
      - name: æå– spider å­—æ®µå¹¶è®¡ç®— MD5
        id: extract_spider
        run: |
          python3 <<EOF
          import json
          import hashlib

          # è¯»å–åŸå§‹ JSON æ–‡ä»¶
          with open("9280.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          # æå– spider å­—æ®µå†…å®¹
          spider_content = json.dumps(data.get("spider", {}), ensure_ascii=False, indent=2)
          spider_md5 = hashlib.md5(spider_content.encode("utf-8")).hexdigest()

          # ä¿å­˜ spider å­—æ®µå†…å®¹
          with open("spider_content.txt", "w", encoding="utf-8") as f:
              f.write(spider_content)

          # ä¿å­˜ spider å­—æ®µçš„ MD5 åˆ°æ–‡ä»¶
          with open("spider_md5.txt", "w") as f:
              f.write(spider_md5)
          EOF

          # è¯»å– spider_md5.txt å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          CURRENT_SPIDER_MD5=$(cat spider_md5.txt)
          echo "å½“å‰ spider å­—æ®µçš„ MD5: $CURRENT_SPIDER_MD5"
          echo "CURRENT_SPIDER_MD5=$CURRENT_SPIDER_MD5" >> $GITHUB_ENV

      # ç¬¬å››æ­¥ï¼šå¯¹æ¯” spider å­—æ®µçš„ MD5
      - name: å¯¹æ¯” spider å­—æ®µçš„ MD5
        id: compare_spider_md5
        run: |
          # è·å–ä¸Šä¸€æ¬¡å‘å¸ƒçš„ spider å­—æ®µ MD5
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          if [[ -z "$response" ]]; then
              echo "é”™è¯¯ï¼šGitHub API è¯·æ±‚å¤±è´¥ã€‚"
              exit 1
          fi
          LATEST_RELEASE_SPIDER_MD5=$(echo "$response" | jq -r '.body' | grep -oP '(?<=Spider MD5: )\w+')

          if [[ -z "$LATEST_RELEASE_SPIDER_MD5" ]]; then
              echo "æœªæ‰¾åˆ°ä¸Šä¸€æ¬¡å‘å¸ƒçš„ spider å­—æ®µ MD5ã€‚"
              LATEST_RELEASE_SPIDER_MD5=""
          else
              echo "ä¸Šä¸€æ¬¡å‘å¸ƒçš„ spider å­—æ®µ MD5: $LATEST_RELEASE_SPIDER_MD5"
          fi

          # è·å–å½“å‰ spider å­—æ®µçš„ MD5
          CURRENT_SPIDER_MD5="${{ env.CURRENT_SPIDER_MD5 }}"
          echo "å½“å‰ spider å­—æ®µçš„ MD5: $CURRENT_SPIDER_MD5"

          # å¯¹æ¯” MD5
          if [[ "$CURRENT_SPIDER_MD5" == "$LATEST_RELEASE_SPIDER_MD5" ]]; then
              echo "spider å­—æ®µæœªä¿®æ”¹ï¼Œç»“æŸè„šæœ¬ã€‚"
              echo "spider_changed=false" >> $GITHUB_OUTPUT
              exit 0
          else
              echo "spider å­—æ®µå·²ä¿®æ”¹ã€‚"
              echo "spider_changed=true" >> $GITHUB_OUTPUT
          fi

      # ç¬¬äº”æ­¥ï¼šè¿è¡Œ Python è„šæœ¬å¤„ç† JSON æ•°æ®
      - name: è¿è¡Œ Python è„šæœ¬å¤„ç† JSON
        if: steps.compare_spider_md5.outputs.spider_changed == 'true'
        id: modify_json
        run: |
          python3 <<EOF
          import json
          import zlib

          # è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„
          input_file = "9280.json"
          output_file = "${{ env.FINAL_JSON }}"

          # éœ€è¦åˆ é™¤çš„é”®åˆ—è¡¨
          keys_to_delete = [
              "Doubana", "Wexconfig", "WexrenrenGuard", "mingriyingshi", "Fujutv", "SubaibaiGuard", "csp_Nmys",
              "Wexliyuan", "Wextangdou", "Wexergeduoduo", "Wexbaobaobashi", "Wexbeiwa", "Wextuxiaobei", "Pandalivetv",
              "Iktv", "WexDm84", "WexYsj", "è‡ªå®šä¹‰", "AList", "bili", "biliych", "Wexqingfengdj", "Wexxsmp3", "Wexpsmp3",
              "Wexwwe", "çœ‹çƒ", "926çœ‹çƒ", "1ç›´æ’­", "Wexduanjuquark", "Wexduanjuvop", "Wexduanjuhema", "WexduanjuvmpGuard",
              "Wexduanju001", "éå‡¡", "æœ¨è€³", "360", "çˆ±å¤", "Wexyingchao"
          ]

          # è¯»å–åŸå§‹ JSON æ–‡ä»¶
          with open(input_file, "r", encoding="utf-8") as f:
              data = json.load(f)

          # åˆ é™¤ä¸éœ€è¦çš„é”®
          if "doh" in data:
              del data["doh"]
          if "lives" in data:
              del data["lives"]

          # ä¿®æ”¹ç‰¹å®šé”®çš„åç§°
          for site in data.get("sites", []):
              if site.get("key") == "Douban":
                  site["name"] = "ğŸ®ã€æ¨èã€‘ğŸ®"
              elif site.get("key") == "Wexokconfig":
                  site["name"] = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®"
              elif site.get("key") == "Wexnullname":
                  site["name"] = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"

          # è¿‡æ»¤æ‰ä¸éœ€è¦çš„ç«™ç‚¹
          data["sites"] = [site for site in data.get("sites", []) if site.get("key") not in keys_to_delete]

          # ä¿å­˜ä¿®æ”¹åçš„ JSON æ–‡ä»¶
          with open(output_file, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print("JSON æ–‡ä»¶å¤„ç†å®Œæˆï¼Œä¿å­˜ä¸º:", output_file)

          # è®¡ç®—å¤„ç†åæ–‡ä»¶çš„ CRC32
          with open(output_file, "rb") as f:
              processed_crc32 = zlib.crc32(f.read()) & 0xffffffff
          with open("processed_crc32.txt", "w") as f:
              f.write(str(processed_crc32))
          EOF

      # ç¬¬å…­æ­¥ï¼šå¯¹æ¯” CRC32
      - name: å¯¹æ¯” CRC32
        if: steps.compare_spider_md5.outputs.spider_changed == 'true'
        id: compare_crc32
        run: |
          PROCESSED_CRC32=$(cat processed_crc32.txt)
          echo "å¤„ç†å JSON æ–‡ä»¶çš„ CRC32: $PROCESSED_CRC32"

          if [[ "$PROCESSED_CRC32" != "$ORIGINAL_CRC32" ]]; then
              echo "JSON æ–‡ä»¶å·²ä¿®æ”¹ã€‚"
              echo "json_changed=true" >> $GITHUB_OUTPUT
          else
              echo "JSON æ–‡ä»¶æœªä¿®æ”¹ï¼Œæ— éœ€ä¸Šä¼ å’Œå‘å¸ƒã€‚"
              echo "json_changed=false" >> $GITHUB_OUTPUT
          fi

      # ç¬¬ä¸ƒæ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ° Kstoreï¼ˆä»…åœ¨ json_changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.compare_crc32.outputs.json_changed == 'true'
        run: |
          curl https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"

      # ç¬¬å…«æ­¥ï¼šå‘å¸ƒ Releasesï¼ˆä»…åœ¨ json_changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: å‘å¸ƒ Releases
        if: steps.compare_crc32.outputs.json_changed == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-$(date +"%Y%m%d-%H%M%S")
          release_name: Release $(date +"%Y%m%d-%H%M%S")
          body: |
            Spider å­—æ®µå†…å®¹å·²æ›´æ–°ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
            ```
            $(cat spider_content.txt)
            ```
            Spider MD5: ${{ env.CURRENT_SPIDER_MD5 }}
          draft: false
          prerelease: false