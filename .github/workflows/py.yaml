name: Delete Old Workflow Runs

on:
  schedule:
    - cron: '0 * * * *'  # 每小时 UTC 时间 00 分执行
  workflow_dispatch: # 添加手动触发 workflow 的选项
    inputs:
      hours_to_keep:
        description: "保留 workflow runs 的小时数"
        required: false
        default: 24

jobs:
  delete-runs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup GitHub CLI
        uses: actions/setup-go@v3
        with:
          go-version: '>=1.20.0'

      - name: Install GitHub CLI
        run: |
          go install github.com/cli/cli/v2/cmd/gh@latest

      - name: Authenticate with GitHub
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Delete old Workflow runs
        run: |
          HOURS_TO_KEEP=${{ github.event.inputs.hours_to_keep || 24 }}  # 默认保留 24 小时的 runs
          echo "开始删除 ${HOURS_TO_KEEP} 小时之前的 Workflow Runs"
          CUTOFF_DATE=$(date -u -d "${HOURS_TO_KEEP} hours ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: ${CUTOFF_DATE}"
          gh run list --repo ${{ github.repository }}  --json '[]' |
          jq -r '.[] | select(.createdAt < "'"${CUTOFF_DATE}"'") | .id' |
          while read RUN_ID; do
            echo "Deleting run: ${RUN_ID}"
            gh run delete "${RUN_ID}" --repo ${{ github.repository }}
          done
