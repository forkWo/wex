name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *' # æ¯ 10 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # æœ€ç»ˆæ–‡ä»¶å‘½åä¸º wex.json

jobs:
  modify:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # ç¬¬äºŒæ­¥ï¼šå®‰è£… jq å·¥å…·
      - name: å®‰è£… jq
        run: sudo apt-get install -y jq

      # ç¬¬ä¸‰æ­¥ï¼šä¸‹è½½ JSON æ–‡ä»¶
      - name: ä¸‹è½½ JSON æ•°æ®
        id: download_json
        run: |
          curl -s "${{ env.JSON_URL }}" -o 9280.json
          echo "JSON æ–‡ä»¶ä¸‹è½½å®Œæˆã€‚"

      # ç¬¬å››æ­¥ï¼šè·å–å®Œæ•´çš„ spider å­—æ®µ
      - name: è·å–å®Œæ•´çš„ spider å­—æ®µ
        id: get_spider_content
        run: |
          SPIDER_CONTENT=$(jq -r '.spider' 9280.json)
          echo "å½“å‰ Spider å­—æ®µå†…å®¹: $SPIDER_CONTENT"
          echo "SPIDER_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$SPIDER_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ç¬¬äº”æ­¥ï¼šè·å–ä¸Šä¸€ä¸ª Releases ç‰ˆæœ¬çš„ spider å­—æ®µ
      - name: è·å–ä¸Šä¸€ä¸ª Releases ç‰ˆæœ¬çš„ spider å­—æ®µ
        id: get_previous_spider_content
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}  # ä½¿ç”¨ PAT
        run: |
          LATEST_RELEASE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          echo "GitHub API å“åº”: $LATEST_RELEASE"  # è°ƒè¯•è¾“å‡º

          # æ£€æŸ¥æ˜¯å¦æœ‰ Releases
          if [[ $(echo "$LATEST_RELEASE" | jq -r '.message') == "Not Found" ]]; then
            echo "ä»“åº“ä¸­æ²¡æœ‰ Releasesï¼Œè·³è¿‡å¯¹æ¯”ã€‚"
            echo "PREVIOUS_SPIDER_CONTENT=no_releases" >> $GITHUB_ENV
          else
            # æå– body å†…å®¹
            BODY=$(echo "$LATEST_RELEASE" | jq -r '.body')
            echo "body å†…å®¹: $BODY"  # è°ƒè¯•è¾“å‡º

            # æå–å®Œæ•´çš„ spider å­—æ®µå†…å®¹
            PREVIOUS_SPIDER_CONTENT=$(echo "$BODY" | grep -oP 'Spider Content: \K.*')
            echo "æå–çš„ Spider å­—æ®µå†…å®¹: $PREVIOUS_SPIDER_CONTENT"  # è°ƒè¯•è¾“å‡º

            # å°†å†…å®¹å†™å…¥ç¯å¢ƒå˜é‡
            echo "PREVIOUS_SPIDER_CONTENT=$PREVIOUS_SPIDER_CONTENT" >> $GITHUB_ENV
          fi

      # ç¬¬å…­æ­¥ï¼šå¯¹æ¯” spider å­—æ®µ
      - name: å¯¹æ¯” spider å­—æ®µ
        id: compare_spider
        run: |
          if [[ "$SPIDER_CONTENT" != "$PREVIOUS_SPIDER_CONTENT" ]]; then
            echo "Spider å­—æ®µå·²ä¿®æ”¹ï¼Œéœ€è¦å¤„ç† JSON æ–‡ä»¶ã€‚"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "Spider å­—æ®µæœªä¿®æ”¹ï¼Œæ— éœ€å¤„ç† JSON æ–‡ä»¶ã€‚"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # ç¬¬ä¸ƒæ­¥ï¼šä¿®æ”¹ JSON æ–‡ä»¶ï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¿®æ”¹ JSON æ–‡ä»¶
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          python3 <<EOF
          import json
          import hashlib

          # è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„
          input_file = "9280.json"
          output_file = "${{ env.FINAL_JSON }}"

          # éœ€è¦åˆ é™¤çš„é”®åˆ—è¡¨
          keys_to_delete = [
              "Doubana", #â¬‡ï¸ã€ç½‘ç›˜ç±»å…ˆæ‰«ç ã€‘â¬‡ï¸
              "Wexconfig", #ğŸ®é€šç”¨ç±»å‹â”ƒé…ç½®ä¸­å¿ƒğŸ®
              "Wexalllive", #ğŸ’“â€èšåˆâ”ƒç›´æ’­ğŸ’“
              "mingriyingshi", #ğŸ˜æ˜æ—¥â”ƒå½±è§†ğŸ˜
              "Fujutv", #ğŸ˜è…å‰§â”ƒå½±è§†ğŸ˜
              "Wexsaohuo", #ğŸ‡ç«ç«â”ƒç§’æ’­ğŸ‡
              "csp_Nmys", #ğŸ‡ä¼¯ä¼¯â”ƒç§’æ’­ğŸ‡
              "éå‡¡","æœ¨è€³", 
              "360", "çˆ±å¤", 
              "Wexhanxiaoquan", #ğŸŒºéŸ©åœˆâ”ƒç§’æ’­ğŸŒº
              "Wexduanjuquark", #ğŸ‰çŸ­å‰§â”ƒå¤¸å…‹ğŸ‰
              "Wexduanjuvop", #ğŸ‰çŸ­å‰§â”ƒç§’æ’­ğŸ‰
              "Wexduanjuhema", #ğŸ‰çŸ­å‰§â”ƒä»™å“ğŸ‰
              "WexduanjuvmpGuard", #ğŸ‰çŸ­å‰§â”ƒå¸å“ğŸ‰
              "WexduanjuvipGuard", #ğŸ‰çŸ­å‰§â”ƒç¥å“ğŸ‰
              "Wexduanju001", #ğŸ‰çŸ­å‰§â”ƒæå“ğŸ‰
              "Wexliyuan", #ğŸæˆæ›²â”ƒç§’æ’­ğŸ
              "Wextangdou", #ğŸ’ƒè·³èˆâ”ƒæ•™å­¦ğŸ’ƒ
              "Wexergeduoduo", #ğŸ‘¼å¤šå¤šâ”ƒå„¿æ­ŒğŸ‘¼
              "Wexbaobaobashi", #ğŸ‘¼å®å®â”ƒå„¿æ­ŒğŸ‘¼
              "Wexbeiwa", #ğŸ‘¼è´è´â”ƒå„¿æ­ŒğŸ‘¼
              "Wextuxiaobei", #ğŸ‘¼å…”å…”â”ƒå„¿æ­ŒğŸ‘¼
              "Pandalivetv", #ğŸ˜éŸ©å›½â”ƒç›´æ’­ğŸ˜
              "Iktv", "è‡ªå®šä¹‰", 
              "AList","bili",
              "biliych", #ğŸ…±å“”å“”â”ƒæ­Œæ›²ğŸ…±
              "Wexqingfengdj", #ğŸ¼èˆæ›²â”ƒæ‘‡å¤´ğŸ¼
              "Wexxsmp3", #ğŸ¤éšèº«â”ƒç›¸å£°ğŸ¤
              "Wexpsmp3", #ğŸ¤éšèº«â”ƒè¯„ä¹¦ğŸ¤
              "Wexwwe", #ğŸŒæ ¼æ–—â”ƒWWEğŸŒ
              "çœ‹çƒ", 
              "926çœ‹çƒ", 
              "1ç›´æ’­",
          ]

          # è¯»å–åŸå§‹ JSON æ–‡ä»¶
          with open(input_file, "r", encoding="utf-8") as f:
              data = json.load(f)

          # åˆ é™¤ä¸éœ€è¦çš„é”®
          if "doh" in data:
              del data["doh"]
          if "lives" in data:
              del data["lives"]

          # ä¿®æ”¹ç‰¹å®šé”®çš„åç§°
          for site in data.get("sites", []):
              if site.get("key") == "Douban":
                  site["name"] = "ğŸ®ã€æ¨èã€‘ğŸ®"
              elif site.get("key") == "Wexokconfig":
                  site["name"] = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®"
              elif site.get("key") == "Wexnullname":
                  site["name"] = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"

          # è¿‡æ»¤æ‰ä¸éœ€è¦çš„ç«™ç‚¹
          data["sites"] = [site for site in data.get("sites", []) if site.get("key") not in keys_to_delete]

          # é‡æ–°æ’åº sites æ•°ç»„ï¼Œå°† "ç©å¶" æ”¾åœ¨ "Wexokconfig" åé¢
          def sort_sites(site):
              if site.get("key") == "Douban":
                  return 1
              elif site.get("key") == "Wexokconfig":
                  return 2
              elif site.get("key") == "ç©å¶":
                  return 3
              else:
                  return 4

          data["sites"].sort(key=sort_sites)

          # ä¿å­˜ä¿®æ”¹åçš„ JSON æ–‡ä»¶
          with open(output_file, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print("JSON æ–‡ä»¶å¤„ç†å®Œæˆï¼Œä¿å­˜ä¸º:", output_file)
          EOF

      # ç¬¬å…«æ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ° Kstoreï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          curl https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"

      # ç¬¬ä¹æ­¥ï¼šå‘å¸ƒæ–°çš„ Releasesï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: å‘å¸ƒæ–°çš„ Releases
        if: steps.compare_spider.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}  # ä½¿ç”¨ PAT
        run: |
          # åˆ‡æ¢åˆ° GitHub Actions çš„é»˜è®¤å·¥ä½œç›®å½•
          cd $GITHUB_WORKSPACE

          # æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦æ˜¯ Git ä»“åº“
          if ! git rev-parse --git-dir > /dev/null 2>&1; then
            echo "å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“ï¼Œæ­£åœ¨åˆå§‹åŒ– Git ä»“åº“..."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
          fi

          # å‘å¸ƒæ–°çš„ Releasesï¼ŒåŒ…å«å®Œæ•´çš„ spider å­—æ®µå†…å®¹
          gh release create v$(date +%Y%m%d%H%M%S) --title "$(date +%Y-%m-%d)" --notes "Spider Content: $SPIDER_CONTENT"

      # ç¬¬åæ­¥ï¼šåˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - name: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å·¥ä½œæµè¿è¡Œè®°å½•
          RUNS=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")

          # æå–éœ€è¦åˆ é™¤çš„è¿è¡Œè®°å½• ID
          OLD_RUN_IDS=$(echo "$RUNS" | jq -r '.workflow_runs[] | select(.status == "completed") | .id')

          # åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
          for RUN_ID in $OLD_RUN_IDS; do
            echo "æ­£åœ¨åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•: $RUN_ID"
            curl -s -X DELETE -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID"
          done