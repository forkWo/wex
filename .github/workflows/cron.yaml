name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # æ¯ä¸¤ä¸ªå°æ—¶è§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # æœ€ç»ˆæ–‡ä»¶å‘½åä¸º wex.json

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šä¸‹è½½ JSON æ–‡ä»¶å¹¶è®¡ç®— MD5
      - name: ä¸‹è½½ JSON æ•°æ®å¹¶è®¡ç®— MD5
        id: download_json
        run: |
          ORIGINAL_MD5=$(curl -s "${{ env.JSON_URL }}" | tee original.json | md5sum | awk '{print $1}')
          echo "åŽŸå§‹ JSON æ–‡ä»¶çš„ MD5: $ORIGINAL_MD5"
          echo "ORIGINAL_MD5=$ORIGINAL_MD5" >> $GITHUB_ENV

      # ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ JSON å†…å®¹
      - name: ä¿®æ”¹ JSON æ•°æ®
        id: modify_json
        run: |
          set -e

          KEYS_TO_DELETE='[
            "Doubana", "Wexconfig", "WexrenrenGuard", "mingriyingshi", "Fujutv", "SubaibaiGuard", "csp_Nmys",
            "Wexliyuan", "Wextangdou", "Wexergeduoduo", "Wexbaobaobashi", "Wexbeiwa", "Wextuxiaobei", "Pandalivetv",
            "Iktv", "WexDm84", "WexYsj", "è‡ªå®šä¹‰", "AList", "bili", "biliych", "Wexqingfengdj", "Wexxsmp3", "Wexpsmp3",
            "Wexwwe", "çœ‹çƒ", "926çœ‹çƒ", "1ç›´æ’­", "Wexduanjuquark", "Wexduanjuvop", "Wexduanjuhema", "WexduanjuvmpGuard",
            "Wexduanju001", "éžå‡¡", "æœ¨è€³", "360", "çˆ±å¤"
          ]'

          if ! jq -c --argjson keys_to_delete "$KEYS_TO_DELETE" '
            del(.doh, .lives) |
            .sites |= (
              map(
                if .key == "Douban" then
                  .name = "ðŸ®ã€æŽ¨èã€‘ðŸ®"
                elif .key == "Wexokconfig" then
                  .name = "ðŸ®é…ç½®ä¸­å¿ƒðŸ®"
                elif .key == "Wexnullname" then
                  .name = "ðŸ’“è§‚å½±â”ƒ4KðŸ’“"
                else
                  .
                end
              ) |
              map(select(.key as $k | $keys_to_delete | index($k) == null))
            )
          ' original.json > modified.json; then
            echo "::error::å¤„ç† JSON æ•°æ®å¤±è´¥ï¼"
            exit 1
          fi

      # ç¬¬ä¸‰æ­¥ï¼šå¯¹æ¯” MD5 å¹¶é‡å‘½åæ–‡ä»¶
      - name: å¯¹æ¯” MD5 å¹¶é‡å‘½åæ–‡ä»¶
        id: compare_md5
        run: |
          set -e

          PROCESSED_MD5=$(md5sum modified.json | awk '{print $1}')
          echo "å¤„ç†åŽ JSON æ–‡ä»¶çš„ MD5: $PROCESSED_MD5"

          if [[ "$ORIGINAL_MD5" != "$PROCESSED_MD5" ]]; then
            echo "JSON æ•°æ®å·²ä¿®æ”¹ã€‚"
            echo "changed=true" >> $GITHUB_OUTPUT
            mv modified.json "${{ env.FINAL_JSON }}"
          else
            echo "JSON æ•°æ®æœªä¿®æ”¹ï¼Œæ— éœ€ä¸Šä¼ ã€‚"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # ä¸Šä¼ æ–‡ä»¶åˆ° Kstoreï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.compare_md5.outputs.changed == 'true'
        run: |
          curl https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"