name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # æ¯ä¸¤ä¸ªå°æ—¶è§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  UPLOAD_URL: "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½ JSON æ•°æ®
        run: |
          echo "å¼€å§‹ä¸‹è½½ JSON æ•°æ®..."
          curl -s "${{ env.JSON_URL }}" > wex.json
          echo "JSON æ•°æ®ä¸‹è½½å®Œæˆã€‚"

      - name: å¤„ç† JSON æ•°æ®
        id: process
        run: |
          echo "å¼€å§‹å¤„ç† JSON æ•°æ®..."
          # å®šä¹‰éœ€è¦åˆ é™¤çš„é”®å’Œéœ€è¦ä¿®æ”¹çš„é”®
          KEYS_TO_DELETE=("Doubana" "Wexconfig" "WexrenrenGuard" "mingriyingshi" "Fujutv" "SubaibaiGuard" "csp_Nmys" "Wexliyuan" "Wextangdou" "Wexergeduoduo" "Wexbaobaobashi" "Wexbeiwa" "Wextuxiaobei" "Pandalivetv" "Iktv" "WexDm84" "WexYsj" "è‡ªå®šä¹‰" "AList" "bili" "biliych" "Wexqingfengdj" "Wexxsmp3" "Wexpsmp3" "Wexwwe" "çœ‹çƒ" "926çœ‹çƒ" "1ç›´æ’­" "Wexduanjuquark" "Wexduanjuvop" "Wexduanjuhema" "WexduanjuvmpGuard" "Wexduanju001" "éå‡¡" "æœ¨è€³" "360" "çˆ±å¤")

          # ä½¿ç”¨ jq å¤„ç† JSON æ•°æ®
          jq '
            . | del(.doh, .lives) |
            .sites = (
              .sites |
              map(
                if .key == "Douban" then
                  .name = "ğŸ®ã€æ¨èã€‘ğŸ®"
                elif .key == "Wexokconfig" then
                  .name = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®"
                elif .key == "Wexnullname" then
                  .name = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"
                else
                  .
                end
              ) |
              map(select(.key as $k | $k != "Doubana" and $k != "Wexconfig" and $k != "WexrenrenGuard" and $k != "mingriyingshi" and $k != "Fujutv" and $k != "SubaibaiGuard" and $k != "csp_Nmys" and $k != "Wexliyuan" and $k != "Wextangdou" and $k != "Wexergeduoduo" and $k != "Wexbaobaobashi" and $k != "Wexbeiwa" and $k != "Wextuxiaobei" and $k != "Pandalivetv" and $k != "Iktv" and $k != "WexDm84" and $k != "WexYsj" and $k != "è‡ªå®šä¹‰" and $k != "AList" and $k != "bili" and $k != "biliych" and $k != "Wexqingfengdj" and $k != "Wexxsmp3" and $k != "Wexpsmp3" and $k != "Wexwwe" and $k != "çœ‹çƒ" and $k != "926çœ‹çƒ" and $k != "1ç›´æ’­" and $k != "Wexduanjuquark" and $k != "Wexduanjuvop" and $k != "Wexduanjuhema" and $k != "WexduanjuvmpGuard" and $k != "Wexduanju001" and $k != "éå‡¡" and $k != "æœ¨è€³" and $k != "360" and $k != "çˆ±å¤"))
            )
          ' wex.json > tmp.json && mv tmp.json wex.json

          # æ£€æŸ¥ JSON æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹
          if [[ $(diff wex.json <(curl -s "${{ env.JSON_URL }}")) ]]; then
            echo "JSON æ•°æ®å·²ä¿®æ”¹ï¼Œè®¾ç½®è¾“å‡º changed ä¸º trueã€‚"
            echo "::set-output name=changed::true"
          else
            echo "JSON æ•°æ®æœªä¿®æ”¹ï¼Œè®¾ç½®è¾“å‡º changed ä¸º falseã€‚"
            echo "::set-output name=changed::false"
          fi
          echo "JSON æ•°æ®å¤„ç†å®Œæˆã€‚"

      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ° Kstore..."
          curl -F "file=@wex.json" "${{ env.UPLOAD_URL }}"
          echo "æ–‡ä»¶ä¸Šä¼ åˆ° Kstore å®Œæˆã€‚"