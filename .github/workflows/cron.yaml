name: Process Wex JSON and Upload to ts Branch

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© 00:00 è§¦å‘ (UTC æ—¶é—´)

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JSON data
        run: |
          curl -s https://9280.kstore.space/wex.json > wex.json

      - name: Process JSON data
        run: |
          jq '. | del(.lives, .doh) | if .Sites then .Sites = (.Sites | map(select(.key != "Doubana" and .key != "Wexconfig"))) | .Sites = (.Sites | map(if .name == "ðŸ®ã€å…¬ä¼—å·ï¼šçŽ‹äºŒå°æ”¾ç‰›å¨ƒã€‘ðŸ®" then .name = "æŽ¨è" else . end)) | .Sites = (.Sites | map(if .name == "ðŸ®é€šç”¨ç±»åž‹â”ƒé…ç½®ä¸­å¿ƒðŸ®" then .name = "é…ç½®ä¸­å¿ƒ" else . end)) else . end' wex.json > processed_wex.json

      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      
      - name: Create or Checkout ts branch
        run: |
          git fetch origin
          if git rev-parse --verify --quiet origin/ts; then
            echo "ts branch exists, checkout it"
            git checkout ts
          else
            echo "ts branch does not exist, create and checkout it"
            git checkout -b ts
          fi

      - name: Commit changes
        run: |
          git add processed_wex.json
          git commit -m "Update processed wex.json" || echo "No changes to commit"

      - name: Push changes to ts branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ts
          force: true