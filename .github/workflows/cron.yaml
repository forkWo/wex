name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # ÊØè‰∏§‰∏™Â∞èÊó∂Ëß¶Âèë‰∏ÄÊ¨°

env:
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}
  JSON_URL: https://9280.kstore.space/wex.json # ÂÆö‰πâ JSON Êï∞ÊçÆÁöÑ URL
  JSON_FILE_NAME: 9280.json # ÂÆö‰πâ‰∏ãËΩΩÁöÑ JSON Êñá‰ª∂Âêç

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ‰∏ãËΩΩ JSON Êï∞ÊçÆ
        id: download_json
        run: |
          echo "ÂºÄÂßã‰∏ãËΩΩ JSON Êï∞ÊçÆ..."
          curl -s "${{ env.JSON_URL }}" > "${{ env.JSON_FILE_NAME }}"
          echo "JSON Êï∞ÊçÆ‰∏ãËΩΩÂÆåÊàê„ÄÇ"
          # ‰øùÂ≠òÂéüÂßãÊñá‰ª∂ÁöÑ hash ÂÄºÁî®‰∫éÂêéÁª≠ÂØπÊØî
          ORIGINAL_HASH=$(sha256sum "${{ env.JSON_FILE_NAME }}" | awk '{print $1}')
          echo "original_hash=$ORIGINAL_HASH" >> "$GITHUB_OUTPUT"

      - name: Â§ÑÁêÜ JSON Êï∞ÊçÆ
        id: process_json
        run: |
          echo "ÂºÄÂßãÂ§ÑÁêÜ JSON Êï∞ÊçÆ..."
          jq '
            . |
            del(.doh, .lives) |
            .sites = (
              .sites | map(
                 if .key == "Douban" then
                  .name = "üêÆ„ÄêÊé®Ëçê„ÄëüêÆ"
                 elif .key == "Wexokconfig" then
                  .name = "üêÆÈÖçÁΩÆ‰∏≠ÂøÉüêÆ"
                 elif .key == "Wexnullname" then
                  .name = "üíìËßÇÂΩ±‚îÉ4Küíì"
                else
                  .
                end
              ) |
              map(select(
                  .key |
                  (
                   (. != "Doubana") and 
                   (. != "Wexconfig") and
                   (. != "WexrenrenGuard") and
                   (. != "mingriyingshi") and
                   (. != "Fujutv") and
                   (. != "SubaibaiGuard") and
                   (. != "csp_Nmys") and
                   (. != "Wexliyuan") and
                   (. != "Wextangdou") and
                   (. != "Wexergeduoduo") and
                   (. != "Wexbaobaobashi") and
                   (. != "Wexbeiwa") and
                   (. != "Wextuxiaobei") and
                   (. != "Pandalivetv") and
                   (. != "Iktv") and
                   (. != "WexDm84") and
                   (. != "WexYsj") and
                   (. != "Ëá™ÂÆö‰πâ") and
                   (. != "AList") and
                   (. != "bili") and
                   (. != "biliych") and
                   (. != "Wexqingfengdj") and
                   (. != "Wexxsmp3") and
                   (. != "Wexpsmp3") and
                   (. != "Wexwwe") and
                   (. != "ÁúãÁêÉ") and
                   (. != "926ÁúãÁêÉ") and
                   (. != "1Áõ¥Êí≠") and
                   (. != "Wexduanjuquark") and
                   (. != "Wexduanjuvop") and
                   (. != "Wexduanjuhema") and
                   (. != "WexduanjuvmpGuard") and
                   (. != "Wexduanju001") and
                   (. != "ÈùûÂá°") and
                   (. != "Êú®ËÄ≥") and
                   (. != "360") and
                   (. != "Áà±Âù§")
                  )
                )
             )
            )
          ' "${{ env.JSON_FILE_NAME }}" > tmp.json && mv tmp.json "${{ env.JSON_FILE_NAME }}"
          echo "JSON Êï∞ÊçÆÂ§ÑÁêÜÂÆåÊàê„ÄÇ"
          
          # ËÆ°ÁÆóÂ§ÑÁêÜÂêéÊñá‰ª∂ÁöÑ hash ÂÄº
          PROCESSED_HASH=$(sha256sum "${{ env.JSON_FILE_NAME }}" | awk '{print $1}')
          echo "processed_hash=$PROCESSED_HASH" >> "$GITHUB_OUTPUT"
          
          # Âà§Êñ≠Êñá‰ª∂ÊòØÂê¶‰øÆÊîπÔºå‰ΩøÁî® hash ÂÄºËøõË°åÂØπÊØî
          if [[ "${{ steps.download_json.outputs.original_hash }}" != "$PROCESSED_HASH" ]]; then
            echo "JSON Êï∞ÊçÆÂ∑≤‰øÆÊîπÔºåËÆæÁΩÆËæìÂá∫ changed ‰∏∫ true„ÄÇ"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "JSON Êï∞ÊçÆÊú™‰øÆÊîπÔºåËÆæÁΩÆËæìÂá∫ changed ‰∏∫ false„ÄÇ"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi


      - name: ‰∏ä‰º†Êñá‰ª∂Âà∞ Kstore
        if: steps.process_json.outputs.changed == 'true'
        run: |
          echo "ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂Âà∞ Kstore..."
          curl -F "file=@${{ env.JSON_FILE_NAME }}" "https://upload.kstore.space/upload/${{ env.KSTORE_ID }}?access_token=${{ env.KSTORE_TOKEN }}"
          echo "Êñá‰ª∂‰∏ä‰º†Âà∞ Kstore ÂÆåÊàê„ÄÇ"