name: Process Wex JSON and Upload to ts Branch

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© 00:00 è§¦å‘ (UTC æ—¶é—´)

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JSON data
        run: |
          curl -s https://9280.kstore.space/wex.json > wex.json

      - name: Process JSON data
        run: |
          jq '
            . | del(.doh, .lives) |
            .sites = (
              .sites |
              map(
                if .key == "Douban" then
                  .name = "ðŸ®ã€æŽ¨èã€‘ðŸ®"
                elif .key == "Wexokconfig" then
                 .name = "ðŸ®é…ç½®ä¸­å¿ƒðŸ®"
                 
               else
                 .
                end
             ) |
             map(select(.key != "Doubana" and .key != "Wexconfig" and .key != "WexrenrenGuard" and .key != "mingriyingshi" and .key != "Fujutv" and .key != "SubaibaiGuard" and .key != "csp_Nmys"  and .key != "Wexliyuan" and .key != "Wextangdou" and .key != "Wexergeduoduo" and .key != "Wexbaobaobashi" and .key != "Wexbeiwa" and .key != "Wextuxiaobei" and .key != "Pandalivetv" and .key != "Iktv" and .key != "WexDm84" and .key != "WexYsj" and .key != "è‡ªå®šä¹‰" and .key != "AList" and .key != "bili" and .key != "biliych" and .key != "Wexqingfengdj" and .key != "Wexxsmp3" and .key != "Wexpsmp3" and .key != "Wexwwe" and .key != "çœ‹çƒ" and .key != "926çœ‹çƒ" and .key != "1ç›´æ’­"  and .key != "Wexduanjuquark" and .key != "Wexduanjuvop" and .key != "Wexduanjuhema" and .key != "WexduanjuvmpGuard" and .key != "Wexduanju001" and .key != "éžå‡¡" and .key != "æœ¨è€³" and .key != "360" and .key != "çˆ±å¤" ))
           )
          ' wex.json > cs.json

      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      
      - name: Create or Checkout ts branch
        run: |
          git fetch origin
          if git rev-parse --verify --quiet origin/ts; then
            echo "ts branch exists, checkout it"
            git checkout ts
          else
            echo "ts branch does not exist, create and checkout it"
            git checkout -b ts
          fi

      - name: Commit changes
        run: |
          git add cs.json
          git commit -m "Update cs.json" || echo "No changes to commit"

      - name: Push changes to ts branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ts
          force: true