name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # æ¯ä¸¤ä¸ªå°æ—¶è§¦å‘ä¸€æ¬¡

env:
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½ JSON æ•°æ®
        run: |
          echo "å¼€å§‹ä¸‹è½½ JSON æ•°æ®..."
          curl -s https://9280.kstore.space/wex.json > 9280.json
          echo "JSON æ•°æ®ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å·²ä¿å­˜ä¸º 9280.jsonã€‚"

      - name: å¤„ç† JSON æ•°æ®
        id: process
        run: |
          echo "å¼€å§‹å¤„ç† JSON æ•°æ®..."
          keys_to_remove='["Doubana", "Wexconfig", "WexrenrenGuard", "mingriyingshi", "Fujutv", "SubaibaiGuard", "csp_Nmys", "Wexliyuan", "Wextangdou", "Wexergeduoduo", "Wexbaobaobashi", "Wexbeiwa", "Wextuxiaobei", "Pandalivetv", "Iktv", "WexDm84", "WexYsj", "è‡ªå®šä¹‰", "AList", "bili", "biliych", "Wexqingfengdj", "Wexxsmp3", "Wexpsmp3", "Wexwwe", "çœ‹çƒ", "926çœ‹çƒ", "1ç›´æ’­", "Wexduanjuquark", "Wexduanjuvop", "Wexduanjuhema", "WexduanjuvmpGuard", "Wexduanju001", "éå‡¡", "æœ¨è€³", "360", "çˆ±å¤"]'
          
          if jq -n --arg keys_to_remove "$keys_to_remove"  '
             (input | del(.doh, .lives) |
            .sites |= (
              map(
                 if .key == "Douban" then
                  .name = "ğŸ®ã€æ¨èã€‘ğŸ®"
                elif .key == "Wexokconfig" then
                  .name = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®"
                 elif .key == "Wexnullname" then
                   .name = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"
                else
                 .
                end
              )
             ) |
              .sites = (.sites | map(select(.key | ($keys_to_remove | contains(.) | not))))
              ) as $new | (input | del(.doh, .lives)) | test($new)' 9280.json
             then
                echo "JSON æ•°æ®æœªä¿®æ”¹ï¼Œè®¾ç½®è¾“å‡º changed ä¸º falseã€‚"
                echo "JSON æ•°æ®æœªä¿®æ”¹ï¼Œä¸è¿›è¡Œä¸Šä¼ ã€‚"
                echo "::set-output name=changed::false"
            else
                echo "JSON æ•°æ®å·²ä¿®æ”¹ï¼Œè®¾ç½®è¾“å‡º changed ä¸º trueã€‚"
                echo "å¼€å§‹ä¿®æ”¹ 9280.json..."
                echo "::set-output name=changed::true"
                 jq  --arg keys_to_remove "$keys_to_remove"  '
                   . | del(.doh, .lives) |
                    .sites |= (
                      map(
                        if .key == "Douban" then
                          .name = "ğŸ®ã€æ¨èã€‘ğŸ®"
                        elif .key == "Wexokconfig" then
                          .name = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®"
                         elif .key == "Wexnullname" then
                           .name = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“"
                        else
                         .
                        end
                      )
                     ) |
                      .sites = (.sites | map(select(.key | ($keys_to_remove | contains(.) | not))))
                  ' 9280.json <> 9280.json
                echo "9280.json ä¿®æ”¹å®Œæˆã€‚"
                
              fi
          echo "JSON æ•°æ®å¤„ç†å®Œæˆã€‚"

      - name: é‡å‘½å JSON æ–‡ä»¶
        if: steps.process.outputs.changed == 'true'
        run: |
           echo "å¼€å§‹å°† 9280.json é‡å‘½åä¸º wex.json..."
           mv 9280.json wex.json
           echo "æ–‡ä»¶é‡å‘½åå®Œæˆã€‚"

      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ° Kstore..."
          curl -F "file=@wex.json" "https://upload.kstore.space/upload/${{ env.KSTORE_ID }}?access_token=${{ env.KSTORE_TOKEN }}" || { echo "ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼"; exit 1; }
          echo "æ–‡ä»¶ä¸Šä¼ åˆ° Kstore å®Œæˆã€‚"

      - name: ç­‰å¾… Kstore ç¼“å­˜æ›´æ–°
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "ç­‰å¾… 10 ç§’ï¼Œè®© Kstore ç¼“å­˜æ›´æ–°..."
          sleep 10
          echo "ç­‰å¾…å®Œæˆã€‚"