name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # 每两个小时触发一次

env:
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载 JSON 数据
        run: |
          curl -s https://9280.kstore.space/wex.json -o 9280.json

      - name: 处理 JSON 数据
        id: process
        run: |
          echo "开始处理 JSON 数据..."
          jq -c '
            . | del(.doh, .lives) |
            .sites = (
              .sites |
              map(
                if .key == "Douban" then
                  .name = "🐮【推荐】🐮"
                elif .key == "Wexokconfig" then
                 .name = "🐮配置中心🐮"
                elif .key == "Wexnullname" then
                 .name = "💓观影┃4K💓"                 
               else
                 .
                end
             ) |
             map(select(.key != "Doubana" and .key != "Wexconfig" and .key != "WexrenrenGuard" and .key != "mingriyingshi" and .key != "Fujutv" and .key != "SubaibaiGuard" and .key != "csp_Nmys"  and .key != "Wexliyuan" and .key != "Wextangdou" and .key != "Wexergeduoduo" and .key != "Wexbaobaobashi" and .key != "Wexbeiwa" and .key != "Wextuxiaobei" and .key != "Pandalivetv" and .key != "Iktv" and .key != "WexDm84" and .key != "WexYsj" and .key != "自定义" and .key != "AList" and .key != "bili" and .key != "biliych" and .key != "Wexqingfengdj" and .key != "Wexxsmp3" and .key != "Wexpsmp3" and .key != "Wexwwe" and .key != "看球" and .key != "926看球" and .key != "1直播" and .key != "Wexduanjuquark" and .key != "Wexduanjuvop" and .key != "Wexduanjuhema" and .key != "WexduanjuvmpGuard" and .key != "Wexduanju001" and .key != "非凡" and .key != "木耳" and .key != "360" and .key != "爱坤"))
           )
          ' 9280.json > wex.json

          # 比较修改后的 wex.json 和在线 wex.json，以判断是否需要上传
          if [[ $(diff wex.json <(curl -s https://9280.kstore.space/wex.json)) ]]; then
            echo "JSON 数据已修改，设置输出 changed 为 true。"
            echo "::set-output name=changed::true"
          else
            echo "JSON 数据未修改，无需上传。"
             echo "::set-output name=changed::false"
          fi
          echo "JSON 数据处理完成。"

      - name: 上传文件到 Kstore
        if: steps.process.outputs.changed == 'true'
        run: |
          curl -F "file=@wex.json" "https://upload.kstore.space/upload/${{ env.KSTORE_ID }}?access_token=${{ env.KSTORE_TOKEN }}"