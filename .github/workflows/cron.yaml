name: Process Wex JSON and Upload to ts Branch

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: '0 0 * * *' # 每天 00:00 触发 (UTC 时间)

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JSON data
        run: |
          curl -s https://9280.kstore.space/wex.json > wex.json

      - name: Process JSON data
        run: |
          jq '. | del(.lives, .doh) | if .Sites then .Sites = (.Sites | map(select(.key != "Doubana" and .key != "Wexconfig"))) | .Sites = (.Sites | map(if .name == "🐮【公众号：王二小放牛娃】🐮" then .name = "推荐" else . end)) | .Sites = (.Sites | map(if .name == "🐮通用类型┃配置中心🐮" then .name = "配置中心" else . end)) else . end' wex.json > processed_wex.json

      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      
      - name: Create or Checkout ts branch
        run: |
          git fetch origin
          if git rev-parse --verify --quiet origin/ts; then
            echo "ts branch exists, checkout it"
            git checkout ts
          else
            echo "ts branch does not exist, create and checkout it"
            git checkout -b ts
          fi

      - name: Commit changes
        run: |
          git add processed_wex.json
          git commit -m "Update processed wex.json" || echo "No changes to commit"

      - name: Push changes to ts branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ts
          force: true