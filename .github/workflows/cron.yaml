name: 更新 ts

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '*/55 * * * *'  # 每 55 分钟执行一次

jobs:
  update-spider:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: 检出代码库
        uses: actions/checkout@v3

      # Step 2: Setup Python
      - name: 设置 Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'  # 指定 Python 版本，避免不确定性

      # Step 3: Cache dependencies
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Step 4: Install necessary dependencies
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests
          
          #  处理可能的依赖冲突
          python -m pip install --upgrade --force-reinstall requests

      # Step 5: 获取并对比 Wex URL
      - name: 获取并对比 Wex URL
        id: get-compare-urls
        run: |
          NEW_WEX_URL=$(curl -s https://9280.kstore.space/wex.json | jq -r '.spider')
          EXISTING_WEX_URL=$(jq -r '.spider' <<< "$(cat $GITHUB_ENV | jq -r '.WEX_JSON')" )
          
          echo "New WEX_URL: $NEW_WEX_URL"
          echo "Existing WEX_URL: $EXISTING_WEX_URL"
          
          if [[ "$NEW_WEX_URL" == "$EXISTING_WEX_URL" ]]; then
            echo "::set-output name=continue::false"
            echo "对比结果一致。停止脚本。"
          else
            echo "::set-output name=continue::true"
            echo "WEX_URL=$NEW_WEX_URL" >> $GITHUB_ENV
            echo "对比结果不同。继续脚本。"
          fi

      # Step 6: 更新 Wex 字段并上传到 Kstore
      - name: 更新 Wex 字段并上传 Kstore
        if: steps.get-compare-urls.outputs.continue == 'true'
        run: |
          # 使用jq 处理JSON，避免 shell 字符串处理的潜在问题
          NEW_JSON=$(curl -s https://9280.kstore.space/wex.json)
          echo "$NEW_JSON" > wex.json
          # 使用 jq 更新 JSON 数据
          UPDATED_JSON=$(jq -s '.spider = "$NEW_WEX_URL"' wex.json)

          # 上传到 Kstore
          curl -X POST -H "Content-Type: application/json" -d "$UPDATED_JSON" -H "Authorization: Bearer ${{ secrets.KSTORE_TOKEN }}" "https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}"