name: Wex JSON Upload and Cleanup (Node.js)

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '*/40 * * * *' # æ¯ 40 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # æœ€ç»ˆæ–‡ä»¶å‘½åä¸º wex.json

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # ä½¿ç”¨ Node.js 18
          cache: 'npm' # ç¼“å­˜ npm ä¾èµ–

      # ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          npm install axios md5 jq -g
          npm install

      # ç¬¬ä¸‰æ­¥ï¼šä¸‹è½½ JSON æ–‡ä»¶
      - name: ä¸‹è½½ JSON æ•°æ®
        id: download_json
        run: |
          curl -s "${{ env.JSON_URL }}" -o 9280.json
          ORIGINAL_MD5=$(md5sum 9280.json | awk '{print $1}')
          echo "åŸå§‹ JSON æ–‡ä»¶çš„ MD5: $ORIGINAL_MD5"
          echo "ORIGINAL_MD5=$ORIGINAL_MD5" >> $GITHUB_ENV

      # ç¬¬å››æ­¥ï¼šè·å–ä¸Šä¸€ä¸ª Releases ç‰ˆæœ¬çš„ spider MD5
      - name: è·å–ä¸Šä¸€ä¸ª Releases ç‰ˆæœ¬çš„ spider MD5
        id: get_previous_spider_md5
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}  # ä½¿ç”¨ PAT
        run: |
          node -e "
          const axios = require('axios');
          const { GITHUB_TOKEN, GITHUB_REPOSITORY } = process.env;

          axios.get('https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest', {
            headers: { Authorization: \`Bearer \${GITHUB_TOKEN}\` }
          })
            .then(response => {
              const body = response.data.body || '';
              const md5Match = body.match(/Spider MD5: ([0-9a-f]{32})/);
              if (md5Match) {
                console.log(\`æå–çš„ MD5 å€¼: \${md5Match[1]}\`);
                console.log(\`::set-env name=PREVIOUS_SPIDER_MD5::\${md5Match[1]}\`);
              } else {
                console.log('æœªæ‰¾åˆ° Spider MD5ï¼Œè·³è¿‡ MD5 å¯¹æ¯”ã€‚');
                console.log('::set-env name=PREVIOUS_SPIDER_MD5::no_releases');
              }
            })
            .catch(error => {
              if (error.response && error.response.status === 404) {
                console.log('ä»“åº“ä¸­æ²¡æœ‰ Releasesï¼Œè·³è¿‡ MD5 å¯¹æ¯”ã€‚');
                console.log('::set-env name=PREVIOUS_SPIDER_MD5::no_releases');
              } else {
                console.error('è·å– Releases å¤±è´¥:', error.message);
                process.exit(1);
              }
            });
          "

      # ç¬¬äº”æ­¥ï¼šå¯¹æ¯” spider å­—æ®µ
      - name: å¯¹æ¯” spider å­—æ®µ
        id: compare_spider
        run: |
          CURRENT_SPIDER_MD5=$(node -e "
            const fs = require('fs');
            const md5 = require('md5');
            const data = JSON.parse(fs.readFileSync('9280.json', 'utf8'));
            console.log(md5(JSON.stringify(data.spider)));
          ")
          echo "å½“å‰ Spider å­—æ®µçš„ MD5: $CURRENT_SPIDER_MD5"

          if [[ "$CURRENT_SPIDER_MD5" != "$PREVIOUS_SPIDER_MD5" ]]; then
            echo "Spider å­—æ®µå·²ä¿®æ”¹ï¼Œéœ€è¦å¤„ç† JSON æ–‡ä»¶ã€‚"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "Spider å­—æ®µæœªä¿®æ”¹ï¼Œæ— éœ€å¤„ç† JSON æ–‡ä»¶ã€‚"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # ç¬¬å…­æ­¥ï¼šä¿®æ”¹ JSON æ–‡ä»¶ï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¿®æ”¹ JSON æ–‡ä»¶
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          node -e "
          const fs = require('fs');
          const inputFile = '9280.json';
          const outputFile = process.env.FINAL_JSON;

          const keysToDelete = [
            'Doubana', 'Wexconfig', 'WexrenrenGuard', 'mingriyingshi', 'Fujutv', 'SubaibaiGuard', 'csp_Nmys',
            'Wexliyuan', 'Wextangdou', 'Wexergeduoduo', 'Wexbaobaobashi', 'Wexbeiwa', 'Wextuxiaobei', 'Pandalivetv',
            'Iktv', 'WexDm84', 'WexYsj', 'è‡ªå®šä¹‰', 'AList', 'bili', 'biliych', 'Wexqingfengdj', 'Wexxsmp3', 'Wexpsmp3',
            'Wexwwe', 'çœ‹çƒ', '926çœ‹çƒ', '1ç›´æ’­', 'Wexduanjuquark', 'Wexduanjuvop', 'Wexduanjuhema', 'WexduanjuvmpGuard',
            'Wexduanju001', 'éå‡¡', 'æœ¨è€³', '360', 'çˆ±å¤', 'Wexyingchao', 'Wexalllive'
          ];

          const data = JSON.parse(fs.readFileSync(inputFile, 'utf8'));

          // åˆ é™¤ä¸éœ€è¦çš„é”®
          if (data.doh) delete data.doh;
          if (data.lives) delete data.lives;

          // ä¿®æ”¹ç‰¹å®šé”®çš„åç§°
          data.sites.forEach(site => {
            if (site.key === 'Douban') site.name = 'ğŸ®ã€æ¨èã€‘ğŸ®';
            if (site.key === 'Wexokconfig') site.name = 'ğŸ®é…ç½®ä¸­å¿ƒğŸ®';
            if (site.key === 'Wexnullname') site.name = 'ğŸ’“è§‚å½±â”ƒ4KğŸ’“';
          });

          // è¿‡æ»¤æ‰ä¸éœ€è¦çš„ç«™ç‚¹
          data.sites = data.sites.filter(site => !keysToDelete.includes(site.key));

          // ä¿å­˜ä¿®æ”¹åçš„ JSON æ–‡ä»¶
          fs.writeFileSync(outputFile, JSON.stringify(data, null, 2), 'utf8');
          console.log(\`JSON æ–‡ä»¶å¤„ç†å®Œæˆï¼Œä¿å­˜ä¸º: \${outputFile}\`);
          "

      # ç¬¬ä¸ƒæ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ° Kstoreï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.compare_spider.outputs.changed == 'true'
        run: |
          curl https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"

      # ç¬¬å…«æ­¥ï¼šå‘å¸ƒæ–°çš„ Releasesï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: å‘å¸ƒæ–°çš„ Releases
        if: steps.compare_spider.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}  # ä½¿ç”¨ PAT
        run: |
          node -e "
          const { execSync } = require('child_process');
          const fs = require('fs');
          const md5 = require('md5');

          // æå–å½“å‰ Spider å­—æ®µçš„ MD5
          const data = JSON.parse(fs.readFileSync('9280.json', 'utf8'));
          const currentSpiderMD5 = md5(JSON.stringify(data.spider));

          // å‘å¸ƒæ–°çš„ Releases
          const releaseName = \`v\${new Date().toISOString().replace(/[^0-9]/g, '')}\`;
          const releaseTitle = \`New Release \${new Date().toISOString().split('T')[0]}\`;
          const releaseNotes = \`Spider MD5: \${currentSpiderMD5}\`;

          execSync(\`gh release create \${releaseName} --title '\${releaseTitle}' --notes '\${releaseNotes}'\`, {
            stdio: 'inherit',
            env: { ...process.env, GH_TOKEN: process.env.GH_TOKEN }
          });
          "

      # ç¬¬ä¹æ­¥ï¼šåˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - name: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const axios = require('axios');
          const { GH_TOKEN, GITHUB_REPOSITORY } = process.env;

          axios.get(\`https://api.github.com/repos/\${GITHUB_REPOSITORY}/actions/runs\`, {
            headers: { Authorization: \`Bearer \${GH_TOKEN}\` }
          })
            .then(response => {
              const runs = response.data.workflow_runs;
              runs.forEach(run => {
                if (run.status === 'completed') {
                  console.log(\`æ­£åœ¨åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•: \${run.id}\`);
                  axios.delete(\`https://api.github.com/repos/\${GITHUB_REPOSITORY}/actions/runs/\${run.id}\`, {
                    headers: { Authorization: \`Bearer \${GH_TOKEN}\` }
                  });
                }
              });
            })
            .catch(error => {
              console.error('åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•å¤±è´¥:', error.message);
              process.exit(1);
            });
          "