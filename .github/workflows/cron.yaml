name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # 每两个小时触发一次

env:
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载 JSON 数据
        run: |
          echo "开始下载 JSON 数据..."
          curl -s https://9280.kstore.space/wex.json -o 9280.json
          echo "JSON 数据下载完成。"

      - name: 处理 JSON 数据
        id: process
        run: |
          echo "开始处理 JSON 数据..."
          
          # 定义要删除的 key
          declare -a keys_to_remove=(
            "Doubana" "Wexconfig" "WexrenrenGuard" "mingriyingshi" "Fujutv" "SubaibaiGuard" "csp_Nmys" "Wexliyuan" 
            "Wextangdou" "Wexergeduoduo" "Wexbaobaobashi" "Wexbeiwa" "Wextuxiaobei" "Pandalivetv" "Iktv" "WexDm84" 
            "WexYsj" "自定义" "AList" "bili" "biliych" "Wexqingfengdj" "Wexxsmp3" "Wexpsmp3" "Wexwwe" "看球" "926看球" "1直播"
            "Wexduanjuquark" "Wexduanjuvop" "Wexduanjuhema" "WexduanjuvmpGuard" "Wexduanju001" "非凡" "木耳" "360" "爱坤"
          )
          
          # 定义需要修改 name 的 key
          declare -a keys_to_rename=(
             "Douban=🐮【推荐】🐮"
             "Wexokconfig=🐮配置中心🐮"
             "Wexnullname=💓观影┃4K💓"
          )
          
          # 将 keys_to_remove 转换为 jq 的 filter 字符串
          remove_filter=$(IFS='|'; echo "${keys_to_remove[*]}" | sed 's/[^|]*/"&"/g' | sed 's/|/ or .key == /g' )
          
          # 将 keys_to_rename 转换为 jq 的 filter 字符串
          rename_filter=$(IFS=' ';
            echo "${keys_to_rename[*]}" |
            while IFS='=' read -r key value; do
              echo "if .key == \"$key\" then .name = \"$value\" else . end"
            done |
            paste -s -d " " -
          )

          # 执行 jq 命令
          if ! jq "
            . | del(.doh, .lives) |
            .sites |= (
              map(
                 $rename_filter
                ) |
                map(select(!( .key == $remove_filter )) )
              )
          " 9280.json > tmp.json; then
            echo "jq 命令执行失败"
            exit 1
          fi
          mv tmp.json wex.json

          if [[ $(diff wex.json <(curl -s https://9280.kstore.space/wex.json)) ]]; then
            echo "JSON 数据已修改，设置输出 changed 为 true。"
            echo "::set-output name=changed::true"
          else
             echo "JSON 数据未修改，设置输出 changed 为 false。"
             echo "::set-output name=changed::false"
          fi
          echo "JSON 数据处理完成。"

      - name: 上传文件到 Kstore
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "开始上传文件到 Kstore..."
          curl -F "file=@wex.json" "https://upload.kstore.space/upload/${{ env.KSTORE_ID }}?access_token=${{ env.KSTORE_TOKEN }}"
          echo "文件上传到 Kstore 完成。"