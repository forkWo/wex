name: Wex JSON Upload

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' # 每两个小时触发一次

env:
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载 JSON 数据
        run: |
          echo "开始下载 JSON 数据..."
          curl -s https://9280.kstore.space/wex.json > wex.json
          echo "JSON 数据下载完成。"

      - name: 处理 JSON 数据
        id: process
        run: |
          echo "开始处理 JSON 数据..."
          keys_to_remove='["Doubana", "Wexconfig", "WexrenrenGuard", "mingriyingshi", "Fujutv", "SubaibaiGuard", "csp_Nmys", "Wexliyuan", "Wextangdou", "Wexergeduoduo", "Wexbaobaobashi", "Wexbeiwa", "Wextuxiaobei", "Pandalivetv", "Iktv", "WexDm84", "WexYsj", "自定义", "AList", "bili", "biliych", "Wexqingfengdj", "Wexxsmp3", "Wexpsmp3", "Wexwwe", "看球", "926看球", "1直播", "Wexduanjuquark", "Wexduanjuvop", "Wexduanjuhema", "WexduanjuvmpGuard", "Wexduanju001", "非凡", "木耳", "360", "爱坤"]'
          jq '
            . | del(.doh, .lives) |
            .sites |= (
              map(
                if .key == "Douban" then
                  .name = "🐮【推荐】🐮"
                elif .key == "Wexokconfig" then
                  .name = "🐮配置中心🐮"
                elif .key == "Wexnullname" then
                   .name = "💓观影┃4K💓"
                else
                 .
                end
              )
             ) |
              .sites = (.sites | map(select(.key | (keys_to_remove | contains(.) | not))))
          ' wex.json  <> wex.json
          
          if [[ $(diff wex.json <(curl -s https://9280.kstore.space/wex.json)) ]]; then
            echo "JSON 数据已修改，设置输出 changed 为 true。"
            echo "::set-output name=changed::true"
            else
             echo "JSON 数据未修改，设置输出 changed 为 false。"
             echo "JSON 数据未修改，不进行上传。"
             echo "::set-output name=changed::false"
          fi
          echo "JSON 数据处理完成。"

      - name: 上传文件到 Kstore
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "开始上传文件到 Kstore..."
          curl -F "file=@wex.json" "https://upload.kstore.space/upload/${{ env.KSTORE_ID }}?access_token=${{ env.KSTORE_TOKEN }}" || { echo "上传文件失败！"; exit 1; }
          echo "文件上传到 Kstore 完成。"

      - name: 等待 Kstore 缓存更新
        if: steps.process.outputs.changed == 'true'
        run: |
          echo "等待 10 秒，让 Kstore 缓存更新..."
          sleep 10
          echo "等待完成。"