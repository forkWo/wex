name: Wex JSON Upload (Node.js)

on:
  push:
    branches:
      - wex
  workflow_dispatch:
  schedule:
     #- cron: '0 */2 * * *' # æ¯ä¸¤ä¸ªå°æ—¶è§¦å‘ä¸€æ¬¡

env:
  JSON_URL: "https://9280.kstore.space/wex.json"
  FINAL_JSON: "wex.json" # æœ€ç»ˆæ–‡ä»¶å‘½åä¸º wex.json

jobs:
  process_json:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18" # ä½¿ç”¨ Node.js 18

      # ç¬¬äºŒæ­¥ï¼šä¸‹è½½ JSON æ–‡ä»¶
      - name: ä¸‹è½½ JSON æ•°æ®
        id: download_json
        run: |
          curl -s "${{ env.JSON_URL }}" -o 9280.json
          ORIGINAL_MD5=$(md5sum 9280.json | awk '{print $1}')
          echo "åŸå§‹ JSON æ–‡ä»¶çš„ MD5: $ORIGINAL_MD5"
          echo "ORIGINAL_MD5=$ORIGINAL_MD5" >> $GITHUB_ENV

      # ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ Node.js è„šæœ¬å¤„ç† JSON æ•°æ®
      - name: è¿è¡Œ Node.js è„šæœ¬å¤„ç† JSON
        id: modify_json
        run: |
          node <<EOF
          const fs = require('fs');

          // è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶è·¯å¾„
          const inputFile = '9280.json';
          const outputFile = '${{ env.FINAL_JSON }}';

          // éœ€è¦åˆ é™¤çš„é”®åˆ—è¡¨
          const keysToDelete = [
            "Doubana", "Wexconfig", "WexrenrenGuard", "mingriyingshi", "Fujutv", "SubaibaiGuard", "csp_Nmys",
            "Wexliyuan", "Wextangdou", "Wexergeduoduo", "Wexbaobaobashi", "Wexbeiwa", "Wextuxiaobei", "Pandalivetv",
            "Iktv", "WexDm84", "WexYsj", "è‡ªå®šä¹‰", "AList", "bili", "biliych", "Wexqingfengdj", "Wexxsmp3", "Wexpsmp3",
            "Wexwwe", "çœ‹çƒ", "926çœ‹çƒ", "1ç›´æ’­", "Wexduanjuquark", "Wexduanjuvop", "Wexduanjuhema", "WexduanjuvmpGuard",
            "Wexduanju001", "éå‡¡", "æœ¨è€³", "360", "çˆ±å¤"
          ];

          // è¯»å–åŸå§‹ JSON æ–‡ä»¶
          const data = JSON.parse(fs.readFileSync(inputFile, 'utf-8'));

          // åˆ é™¤ä¸éœ€è¦çš„é”®
          delete data.doh;
          delete data.lives;

          // ä¿®æ”¹ç‰¹å®šé”®çš„åç§°
          if (data.sites) {
            data.sites = data.sites.map(site => {
              if (site.key === "Douban") {
                site.name = "ğŸ®ã€æ¨èã€‘ğŸ®";
              } else if (site.key === "Wexokconfig") {
                site.name = "ğŸ®é…ç½®ä¸­å¿ƒğŸ®";
              } else if (site.key === "Wexnullname") {
                site.name = "ğŸ’“è§‚å½±â”ƒ4KğŸ’“";
              }
              return site;
            });

            // è¿‡æ»¤æ‰ä¸éœ€è¦çš„ç«™ç‚¹
            data.sites = data.sites.filter(site => !keysToDelete.includes(site.key));
          }

          // ä¿å­˜ä¿®æ”¹åçš„ JSON æ–‡ä»¶
          fs.writeFileSync(outputFile, JSON.stringify(data, null, 2), 'utf-8');

          console.log('JSON æ–‡ä»¶å¤„ç†å®Œæˆï¼Œä¿å­˜ä¸º:', outputFile);
          EOF

      # ç¬¬å››æ­¥ï¼šå¯¹æ¯” MD5 å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸Šä¼ 
      - name: å¯¹æ¯” MD5 å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸Šä¼ 
        id: compare_md5
        run: |
          PROCESSED_MD5=$(md5sum "${{ env.FINAL_JSON }}" | awk '{print $1}')
          echo "å¤„ç†å JSON æ–‡ä»¶çš„ MD5: $PROCESSED_MD5"

          if [[ "$ORIGINAL_MD5" != "$PROCESSED_MD5" ]]; then
              echo "JSON æ•°æ®å·²ä¿®æ”¹ã€‚"
              echo "changed=true" >> $GITHUB_OUTPUT
          else
              echo "JSON æ•°æ®æœªä¿®æ”¹ï¼Œæ— éœ€ä¸Šä¼ ã€‚"
              echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # ç¬¬äº”æ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ° Kstoreï¼ˆä»…åœ¨ changed ä¸º true æ—¶æ‰§è¡Œï¼‰
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Kstore
        if: steps.compare_md5.outputs.changed == 'true'
        run: |
          curl https://upload.kstore.dev/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }} -F "file=@${{ env.FINAL_JSON }}"