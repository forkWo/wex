name: 更新 ts

on:
  push:
    branches:
      - ts
  workflow_dispatch:
  schedule:
    - cron: '*/55 * * * *'  # 每 55 分钟执行一次

jobs:
  update-spider:
    runs-on: ubuntu-latest
    env:
      KSTORE_URL: "https://9280.kstore.space/wex.json"
      KSTORE_UPLOAD_URL: "https://upload.kstore.dev/upload/YOUR_KSTORE_ID"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jq

      - name: Get WEX URL
        id: get-wex-url
        run: |
          NEW_WEX_URL=$(curl -s "$KSTORE_URL" | jq -r '.spider') || (echo "Error fetching WEX URL"; exit 1)
          echo "::set-env name=NEW_WEX_URL::${NEW_WEX_URL}"

      - name: Compare and Update WEX URL
        id: compare-update
        run: |
          EXISTING_WEX_URL=$(cat wex.json 2>/dev/null || echo '{}' | jq -r '.spider') #Handle missing file and error
          if [[ "$NEW_WEX_URL" == "$EXISTING_WEX_URL" ]]; then
            echo "::set-output name=updated::false"
            echo "WEX URLs are identical. No update needed."
          else
            echo "::set-output name=updated::true"
            #Efficient JSON update using jq
            UPDATED_JSON=$(jq --arg new_url "$NEW_WEX_URL" '.spider = $new_url' wex.json) || (echo "Error updating JSON"; exit 1)
            echo "$UPDATED_JSON" > wex.json
            echo "WEX URL updated successfully."
          fi

      - name: Upload to Kstore
        if: steps.compare-update.outputs.updated == 'true'
        run: |
          RESPONSE=$(curl -X POST -H "Content-Type: application/json" -d "$(cat wex.json)" -H "Authorization: Bearer ${{ secrets.KSTORE_TOKEN }}" "$KSTORE_UPLOAD_URL" -o /dev/null -w '%{http_code}')
          if [[ "$RESPONSE" == "200" ]]; then
            echo "Uploaded updated JSON to Kstore successfully."
          else
            echo "Error uploading to Kstore: HTTP status code $RESPONSE"
            exit 1
          fi

      - name: Download initial WEX JSON
        if: always()
        run: |
          RESPONSE=$(curl -s "$KSTORE_URL" -o wex.json -w '%{http_code}')
          if [[ "$RESPONSE" == "200" ]]; then
            echo "Downloaded WEX JSON successfully."
          else
            echo "Error downloading WEX JSON: HTTP status code $RESPONSE"
            # Consider whether to exit here or continue.  Depends on your needs.
          fi